{{define "job_detail.html"}}
<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-100">
<head>
    <meta charset="UTF-8" />
    <title>SATFARM – Job {{.JobID}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="h-full text-slate-900">
<div class="min-h-screen bg-slate-100">
    <main class="max-w-4xl mx-auto px-4 py-6 space-y-6" id="app">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold tracking-tight">Job #{{.JobID}}</h1>
                <p class="text-xs text-slate-500 mt-0.5">Loading…</p>
            </div>
            <a href="/dashboard" class="text-xs text-slate-600 hover:underline">
                ← Back to dashboard
            </a>
        </div>

        <section class="bg-white border border-slate-200 rounded-md p-4 text-sm">
            <div class="text-xs text-slate-500">Fetching job details…</div>
        </section>
    </main>
</div>

<script>
(function () {
  const JOB_ID = {{.JobID}};
  const POLL_MS = 2000;

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function badge(text, kind) {
    const cls = {
      emerald: "bg-emerald-50 text-emerald-700",
      blue: "bg-blue-50 text-blue-700",
      rose: "bg-rose-50 text-rose-700",
      slate: "bg-slate-50 text-slate-700",
      purple: "bg-purple-50 text-purple-700",
      amber: "bg-amber-50 text-amber-700",
    }[kind] || "bg-slate-50 text-slate-700";

    return `<span class="inline-flex items-center rounded-full ${cls} px-2 py-0.5 text-[11px]">${esc(text)}</span>`;
  }

  function jobStatusBadge(status) {
    if (status === "completed") return badge("completed", "emerald");
    if (status === "running")   return badge("running", "blue");
    if (status === "failed")    return badge("failed", "rose");
    if (status === "pending")   return badge("pending", "slate");
    return badge(status || "–", "slate");
  }

  function resultKindBadge(kind) {
    if (!kind) return "–";
    if (kind === "SAT") return badge("SAT", "emerald");
    if (kind === "UNSAT") return badge("UNSAT", "purple");
    return esc(kind);
  }

  function verificationBadge(status) {
    if (!status) return "–";
    if (status === "verified") return badge("verified", "emerald");
    if (status === "unverified") return badge("unverified", "amber");
    return esc(status);
  }

  function renderShardRow(sh) {
    return `
      <tr>
        <td class="px-3 py-1.5 font-mono">${esc(sh.ID)}</td>
        <td class="px-3 py-1.5">${jobStatusBadge(sh.ShardStatus)}</td>
        <td class="px-3 py-1.5">${sh.ResultKind ? resultKindBadge(sh.ResultKind) : "–"}</td>
        <td class="px-3 py-1.5">${sh.ResultStatus ? verificationBadge(sh.ResultStatus) : "–"}</td>
        <td class="px-3 py-1.5 font-mono text-[11px]">${sh.Assignment ? esc(sh.Assignment) : "–"}</td>
        <td class="px-3 py-1.5 font-mono text-[11px]">${sh.DratFileLabel ? esc(sh.DratFileLabel) : "–"}</td>
        <td class="px-3 py-1.5 font-mono text-[11px]">${esc(sh.Cube)}</td>
        <td class="px-3 py-1.5">${esc(sh.CreatedAt)}</td>
        <td class="px-3 py-1.5">${esc(sh.UpdatedAt)}</td>
      </tr>
    `;
  }

  function renderAll(data) {
    const job = data.job || {};
    const result = data.result || {};
    const shards = data.shards || [];

    const resultTime = result.HasResult
      ? (result.CreatedAt || "(time unknown)")
      : "–";

    const shardsBody = shards.length
      ? shards.map(renderShardRow).join("")
      : `
        <tr>
          <td colspan="9" class="px-3 py-3 text-center text-slate-400 text-[11px]">
            No shards for this job yet.
          </td>
        </tr>
      `;

    return `
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-lg font-semibold tracking-tight">Job #${esc(job.ID ?? JOB_ID)}</h1>
          <p class="text-xs text-slate-500 mt-0.5">
            File: <span class="font-mono">${esc(job.FileName || "(unknown)")}</span>
          </p>
        </div>
        <a href="/dashboard" class="text-xs text-slate-600 hover:underline">
          ← Back to dashboard
        </a>
      </div>

      <section class="bg-white border border-slate-200 rounded-md p-4 space-y-4 text-sm">
        <div class="flex flex-wrap gap-4">
          <div>
            <div class="text-[11px] uppercase text-slate-500">Job status</div>
            <div class="mt-1">${jobStatusBadge(job.Status)}</div>
          </div>
          <div>
            <div class="text-[11px] uppercase text-slate-500">Max workers</div>
            <div class="mt-1 font-mono">${esc(job.MaxWorkers)}</div>
          </div>
          <div>
            <div class="text-[11px] uppercase text-slate-500">Created at</div>
            <div class="mt-1 text-xs">${esc(job.CreatedAt)}</div>
          </div>
          <div>
            <div class="text-[11px] uppercase text-slate-500">Result time</div>
            <div class="mt-1 text-xs">${esc(resultTime)}</div>
          </div>
        </div>
      </section>

      <section class="bg-white border border-slate-200 rounded-md p-4 space-y-3 text-sm">
        <h2 class="text-sm font-semibold tracking-tight text-slate-900">
          Shards (${shards.length})
        </h2>

        <div class="border border-slate-200 rounded-md">
          <div class="max-h-80 overflow-y-auto" id="shardsScroll">
            <table class="w-full text-xs">
              <thead class="bg-slate-50 text-slate-500 sticky top-0">
                <tr>
                  <th class="px-3 py-1.5 text-left font-medium">Shard ID</th>
                  <th class="px-3 py-1.5 text-left font-medium">Shard status</th>
                  <th class="px-3 py-1.5 text-left font-medium">Result</th>
                  <th class="px-3 py-1.5 text-left font-medium">Verification</th>
                  <th class="px-3 py-1.5 text-left font-medium">Assignment (SAT)</th>
                  <th class="px-3 py-1.5 text-left font-medium">DRAT file (UNSAT)</th>
                  <th class="px-3 py-1.5 text-left font-medium">Cube literals</th>
                  <th class="px-3 py-1.5 text-left font-medium">Created</th>
                  <th class="px-3 py-1.5 text-left font-medium">Updated</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200 text-slate-700">
                ${shardsBody}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    `;
  }

  function fingerprint(data) {
    const j = data.job || {};
    const r = data.result || {};
    const s = (data.shards || []).map(x => [
      x.ID,
      x.ShardStatus,
      x.ResultKind,
      x.ResultStatus,
      x.Assignment,
      x.DratFileLabel,
      x.UpdatedAt
    ]);
    return JSON.stringify([j.Status, r.HasResult, r.Kind, r.Assignment, r.CreatedAt, s]);
  }

  let lastFP = "";

  async function tick() {
    const res = await fetch(`/api/job/${JOB_ID}`, { credentials: "same-origin" });
    if (!res.ok) return setTimeout(tick, POLL_MS);

    const data = await res.json();
    if (!data || !data.ok) return setTimeout(tick, POLL_MS);

    const fp = fingerprint(data);
    if (fp !== lastFP) {
      lastFP = fp;

      const oldScroll = document.getElementById("shardsScroll");
      const scrollTop = oldScroll ? oldScroll.scrollTop : 0;

      document.getElementById("app").innerHTML = renderAll(data);

      const newScroll = document.getElementById("shardsScroll");
      if (newScroll) newScroll.scrollTop = scrollTop;
    }

    if (data.job?.Status !== "completed" && data.job?.Status !== "failed") {
      setTimeout(tick, POLL_MS);
    }
  }

  tick();
})();
</script>

</body>
</html>
{{end}}